# App Profiler

This module contains script that profile apps deployed to the targeted PCF foundation.

## Pre-requisites 

### CF CLI
The script uses [cf cli](plugins/cf-cli_6.24.0_linux_x86-64) ver 6.20 or newer


### Plugins

The script relies on following plugins 

  * Usage Report plugin
	  * This modified plugin is [usagereport-plugin-1.4.2](https://github.com/akoranne/usagereport-plugin/tree/master/bin)
		  is a fork of the plugin repo created by Josh Kruck [usagereport-plugin](https://github.com/krujos/usagereport-plugin)
    * The master branch pull request is pending.
  * Buildpack Usage plugin
    * This plugin was created by Rahul Jain [cf-buildpacks-usage](https://github.com/rahul-kj/cf_buildpacks_usage) plugin.
    * The plugin generates verbose details of running application with `--verbose` argument.
    * The plugin generates buildpack details with `--csv` argument.
  * Get Events plugin
    * This plugin was created by Ajay Koranne for Citi [cf_get_events](https://github.com/ECSTeam/cf_get_events/releases)
    * The plugin generates a csv file with event details.


### Outputs
The script takes a switch `-l`. The valid logger destination options are `splunk` or `statsd`.
In both destination formats, the message event is timestamped.

#### Splunk Forwarder

**Splunk Forwarder** is an agent that is installed on the vm.

The Splunk Forwarder process runs in the background monitoring pre-set folders for new files.
When a new output file is generated by the script in one of these output folders, the forwarder forwards the file, along with the metadata, to Splunk.

#### StatsD

For `statsd` destination, the script creates events and pipes them using `netcat` utility. 


### CF Settings

`get_pcf_apps.sh` is the main script. 

The script depends on `cf_settings.sh` which contains the target PCF foundation details.
Here are the template details.
```
	### binaries
	# cf cli 
	cf="/usr/local/bin/cf"
	# GnuPG utility
	gpg2="/usr/local/bin/gpg2"
	# netcat utility (for statsd only)
	nc="/usr/bin/nc"

	# is the password encrypted (gpg2)
	pwd_encrypted=true

	# skip ssl validation (leave it blank, if not using it)
	skip_ssl="--skip-ssl-validation"

	# cf target
	cf_target="https://api.local2.pcfdev.io";

	# defaults to login
	cf_org="pcfdev-org";
	cf_space="pcfdev-space";
	cf_user="user";

	# if password is encrypted, `cf_pwd` will be ignored.
	cf_pwd="pass";
```

### Password Encryption

The script can take an encrypted password. 
To setup an encrypted password, follow the instructions [Encrypt Password Using GPG](encrypt-password-using-GPG.md).

### PCF User access

The account used for running the script, should atleast have `space-developer` access and 
it should have `org-manager` grants for the PCF Orgs you wish to profile. 

Here are the steps to create the user with `admin` privileges.

```
	$> uaac target https://uaa.[your cf system domain] --skip-ssl-validation
	$> uaac token client get admin -s [your admin-secret]
	$> cf create-user [script user] [script password]
	$> uaac member add cloud_controller.admin [your script user]
	$> uaac member add uaa.admin [your script user]
```


## How to run this script

1. Edit the `cf_settings` and make changes as needed.
	If using encrypted mode please follow  [Encrypt Password Using GPG](encrypt-password-using-GPG.md) instructions on how to encrypt password with `GngPG` utility. 

2. Login to the PCF foundation with a privileged account. The account should atleast have `space-developer` access and it should have `org-manager` grants for the PCF Orgs you wish to profile. 

3. The script can be ran from command line or schedule as a cron job to profile apps on a periodic basis. 

## Usage

```
	$> ./get_pcf_apps.sh \
			[-r <app#>] \
			[-l <splunk|statsd>] \
			[-t <tagName>] \ 
			[-e <envrionment>] \
			{	[-f <fwdLoc>] or \
				[-i <ipAddr>] [-p <port>] } [addtlArgs]

		where 'app#' are:
                1: Get the list of apps
                2: Get the list of buildpacks and apps using them
                3: Get list of microservices events
                4: Get space details (quotas, use)
                5: Get buildpacks status details

			'tagName':     identifier tag  (e.g. ecs )
			'environment': PCF foundation identifier (e.g. lab02, lab03)
			'fwdLoc':      path to folder, read by Splunk Forwarder (e.g ./outputs)
			'ipAddr':      ip address of the 'Statsd' listener 
			'port':        port of the 'Statsd' listener
			'addtlArgs':   for events only, [--today | --yesterday | --date <yyyymmdd>

```


## Example

* Get list of apps with their allottment details.
```
	$> ./get_pcf_apps.sh -r 1 -l splunk -t pcfdev -e local -f /tmp/outputs
```

* List buildpacks and apps that use them.
```
	$> ./get_pcf_apps.sh -r 2 -l splunk -t pcfdev -e local -f /tmp/outputs
```

* Get all events for today
```
	$> ./get_pcf_apps.sh -r 3 -l splunk -t pcfdev -e local -f /tmp/outputs --yesterday
```

* Get space details (quotas, use)
```
	$> ./get_pcf_apps.sh -r 4 -l splunk -t pcfdev -e local -f /tmp/outputs
```

* Get all buildpacks deployed, with their status from the PCF foundation.
```
	$> ./get_pcf_apps.sh -r 5 -l splunk -t pcfdev -e local -f "/tmp/outputs"
```
